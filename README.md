# Розгортання kaif-app через EKS Cluster

Цей документ описує процес розгортання інфраструктури та додатку `kaif-app` у Amazon EKS (Elastic Kubernetes Service), використовуючи Terraform для інфраструктури та GitHub Actions для CI/CD.

## Розгортання інфраструктури через Terraform

Усі конфігураційні файли Terraform зберігаються у директорії `/terraform_eks`:

- `main.tf` - Основні налаштування ресурсів.
- `outputs.tf` - Виведення значень після розгортання.
- `terraform.tf` - Конфігурація версій Terraform.
- `variables.tf` - Визначення змінних для конфігурації.

### Основні компоненти сетапу:

- **Provider Block**: Конфігурує провайдера AWS для використання у шаблоні.
- **VPC Module**: Створення віртуальної приватної хмари для ізоляції ресурсів EKS.
- **EKS Module**: Ініціація Kubernetes кластеру та управління ним.
- **IRSA (IAM Roles for Service Accounts)**: Надання прав доступу до AWS сервісів з Kubernetes.

### Кроки для розгортання:

1. **`terraform init`**: Ініціалізує робочий каталог Terraform.
2. **`terraform fmt`**: Форматує файли конфігурації для покращення читабельності.
3. **`terraform plan`**: Показує, які дії буде виконано Terraform під час застосування конфігурації.
4. **`terraform apply`**: Застосовує конфігурацію Terraform для створення визначених ресурсів.

**Перед виконанням команд, важливо здійснити налаштування облікових даних AWS для інтеграції з вашим аккаунтом.**

Після створення інфраструктури за допомогою Terraform, налаштуйте ваш `kubeconfig` файл для взаємодії з вашим кластером, виконавши наступну команду:

```bash
aws eks --region us-east-1 update-kubeconfig --name kaif-app-eks
```

Можна виконати команду:
```
kubectl get nodes
```
щоб перевірити стан кластеру.

## CI/CD через GitHub Actions

### Секрети для GitHub Actions:

- `AWS_ARN_ROLE`: ARN ролі AWS, яка надає права доступу для дій, що вимагаються пайплайном.
- `AWS_REGION`: Регіон AWS, де знаходиться EKS кластер.
- `EKS_CLUSTER_NAME`: Назва EKS кластеру.
- `AWS_REPO_URI`: URI AWS ECR репозиторію для зберігання Docker образів.

### Пайплайн "Deploy kaif-app app in AWS EKS":

1. **`build`**: Збирає Docker образ проекту та завантажує його у AWS ECR.
2. **`deploy`**: Оновлює Kubernetes маніфест та застосовує його до EKS кластеру для розгортання додатку.

### Як працює:

- Після кожного push у гілку `eks_cluster`, GitHub Actions автоматично запускає пайплайн.
- Спочатку збирається Docker образ і завантажується в AWS ECR.
- Потім оновлюється Kubernetes маніфест та застосовується до EKS кластеру для розгортання або оновлення додатку.

## Демонстрація роботи сайту

Після успішного розгортання та оновлення контенту, сайт буде доступний через LoadBalancer, створений для EKS сервісу.
Перевірити переглянути ресурси кластера можна командою `kubectl get all -A`

![Огляд кластеру](/gif/kubectl_get.jpg)

Ця команда виведе список усіх запущених подів, служб, розгортань тощо, що дозволить вам перевірити, чи ваші сервіси працюють належним чином. Наприклад - сервіс kaif-app доступний ззовні через `LoadBalancer` по URL який буде вказаний в блоку `EXTERNAL-IP` , що було створено автоматично.


![Демонстрація сайту](/gif/kaif-app-eks.gif)